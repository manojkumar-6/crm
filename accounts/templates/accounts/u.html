{% extends 'accounts/base.html' %} {% block title %}User Management{% endblock %} {% block content %}
<div class="container my-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="display-6 text-dark">Dashboard access</h1>
        </div>
        <div class="col-auto text-end">
            <button class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#createUserModal">Add New User</button>
        </div>
    </div>

    <!-- Filter Dropdown -->
    <div class="row my-3">
        <div class="col">
            <label for="filterSuperuser" class="form-label">Filter by Superuser Status</label>
            <select class="form-select" id="filterSuperuser" onchange="filterUsers()">
                <option value="all">All Users</option>
                <option value="true">Superusers Only</option>
                <option value="false">Non-Superusers</option>
            </select>
        </div>
    </div>

    <!-- User List Table -->
    <div class="table-responsive mt-3">
        <table class="table table-hover rounded table-bordered" id="userTable">
            <thead class="table-dark rounded">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Superuser</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for user in users %}
                <tr id="user-{{ user.id }}" data-is-superuser="{{ user.is_superuser }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.is_superuser|yesno:"Yes,No" }}</td>
                    <td>
                        <button class="btn btn-warning btn-sm rounded-pill" onclick="editUser({{ user.id }})">Edit</button>
                        <button class="btn btn-danger btn-sm rounded-pill" onclick="deleteUser({{ user.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="create-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="create-username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="create-email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-is_superuser" class="form-label">Superuser</label>
                        <select class="form-select" id="create-is_superuser" name="is_superuser">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="createUser()">Create</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit-user-id" name="user_id">
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit-username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit-email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-is_superuser" class="form-label">Superuser</label>
                        <select class="form-select" id="edit-is_superuser" name="is_superuser">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="updateUser()">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Filter Users by Superuser Status
    function filterUsers() {
        var filterValue = document.getElementById('filterSuperuser').value;
        var tableRows = document.querySelectorAll('#userTableBody tr');

        tableRows.forEach(function(row) {
            console.log(row.getAttribute('data-is-superuser'), filterValue)
            var isSuperuser = row.getAttribute('data-is-superuser') === 'True';
            if (filterValue === 'all') {
                row.style.display = '';
            } else if (filterValue === 'true' && isSuperuser) {
                row.style.display = '';
            } else if (filterValue === 'false' && !isSuperuser) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Create User
    function createUser() {
        var form = document.getElementById('createUserForm');
        var formData = new FormData(form);

        fetch("{% url 'create_user' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }

    // Populate the edit modal with user data
    function editUser(id) {
        fetch("{% url 'get_user' %}?id=" + id)
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit-user-id').value = data.id;
                document.getElementById('edit-username').value = data.username;
                document.getElementById('edit-email').value = data.email;
                document.getElementById('edit-is_superuser').value = data.is_superuser;
                var modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            });
    }

    // Update User
    function updateUser() {
        var form = document.getElementById('editUserForm');
        var formData = new FormData(form);

        fetch("{% url 'update_user' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }

    // Delete User
    function deleteUser(id) {
        if (confirm('Are you sure you want to delete this user?')) {
            fetch("{% url 'delete_user' %}?id=" + id, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('user-' + id).remove();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }
    }
</script>

<style>
    .table {
        border-radius: 10px;
        overflow: hidden;
        /* Ensures rounded corners are applied to the table */
    }
    
    .table th,
    .table td {
        border: 1px solid #dee2e6;
    }
    /* Full-width filter styling */
    
    .form-select {
        width: 100%;
    }
</style>

{% endblock %}